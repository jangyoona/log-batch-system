<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.log.batch.actionlog.mapper.PostActionLogBatchMapper">

    <!-- 1) PENDING 로그를 "전일 기준"으로 집계해서 읽기 (Reader용)
         - MyBatisPagingItemReader가 page/size를 넣어서 호출함
         - ORDER BY 필수(페이징 안정성) -->
    <select id="selectDailyStats" resultType="PostActionLogDailyStatusDto">
        SELECT
            DATE(action_time) AS stat_date,
            post_id           AS post_id,
            action_type       AS action_type,
            COUNT(*)          AS cnt
        FROM
            post_action_log
        WHERE
            status = 'PENDING'
            <![CDATA[
                AND action_time >= #{from}
                AND action_time < #{to}
            ]]>
        GROUP BY
            DATE(action_time), post_id, action_type
        ORDER BY
            stat_date, post_id, action_type
    </select>

    <!-- 2) 집계 결과 UPSERT (Writer용) -->
    <insert id="upsertDailyStats">
        INSERT INTO post_action_log_daily_stats
            (stat_date, post_id, action_type, cnt, created_at, updated_at)
        VALUES
            (#{statDate}, #{postId}, #{actionType}, #{cnt}, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
        ON DUPLICATE KEY UPDATE
            cnt = cnt + VALUES(cnt),
            updated_at = CURRENT_TIMESTAMP
    </insert>

    <!-- 3) 처리 완료 마킹 (Step2 Tasklet용) -->
    <update id="markDone">
        UPDATE post_action_log
        SET status = 'DONE'
        WHERE
            status = 'PENDING'
            <![CDATA[
                AND action_time >= #{from}
                AND action_time < #{to}
            ]]>
    </update>



</mapper>